{# description: top-level integration results tests #}
<h2>
  Integration Test Results
  {% if _version|default(False) %}(Release {{ _version }}){% endif %}
</h2>
{% set github_url = "https://github.com/ipspace/netlab/blob/dev/tests/integration/" %}
{% set data_path = results._path.split('/',2) %}
<table>
{% for hdr in ('Device','Provider','Test suite') %}
{%   if data_path|length >= loop.index %}
{%     set url = data_path[0]+"-"+data_path[1]+".html" if loop.index == 2 else "coverage."+data_path[2].replace('/','.')+".html" if loop.index == 3 else "" %}
  <tr>
    <th>{{ hdr }}</td>
    <td>{% if url %}<a href="{{ url }}">{% endif %}{{ data_path[loop.index - 1] }}{% if url %}</a>{% endif %}</td>
  </tr>
{%   endif %}
{% endfor %}
</table>
<hr>

{#
   Display summary test result with pointer to the next HTML file
#}
{% macro suite_result(t_data,cnt,txt,show_final = False) %}
{%   set pass_mark = 
       cnt not in t_data.count and not show_final or
       show_final and 'pass' in t_data._count and cnt not in t_data._count and 'caveat' not in t_data._count %}
{%   set caveat = show_final and 'caveat' in t_data._count %}
<td class="{{ 'center' if pass_mark else 'left' }}">{%
  if cnt in t_data._count or caveat
  %}{% set has_data = t_data._count[cnt] %}{% 
    if has_data %}{{ t_data._count[cnt] }} {{ txt }}{% endif %}{% 
    if show_final and 'caveat' in t_data._count 
  %}{% if has_data %}, {% endif %}{{ t_data._count.caveat }} caveat(s){% endif %}{%
    if show_final and 'pass' in t_data._count %}, {{ t_data._count.pass }} passed{% endif %}
{%   elif not show_final %}
  &#x2705;
{%   elif show_final and 'warning' in t_data._count %}
  <span style='color: orange;'>&#x2714;</span>
{%   elif show_final and 'pass' in t_data._count %}
  &#x2705;
{%   endif %}
</td>
{% endmacro %}
{#
   Display individual test result with pointer to the log file
#}
{% macro test_result(t_name,t_data,cnt,fname) %}
<td class='center'>
{%   if cnt in t_data %}
  <a href="../{{ results._path }}/{{ t_name }}.yml-{{ fname }}.log">
{% if not(t_data[cnt]) %}
    &#x274C;{{ ' (more)' if cnt == 'validate' }}
{% elif cnt == 'validate' and t_data[cnt] == 'warning' %}
    <span style='color: orange;'>&#x2714;</span>
{% else %}
    &#x2705;
{% endif %}
  </a>
{%   endif %}
{% endmacro %}
</td>
<table>
  <tr>
    <th>Test</th>
    <th class='center'>Supported</th>
    <th class='center'>Lab<br>started</th>
    <th class='center'>Devices<br>configured</th>
    <th class='center'>Validated</th>
  </tr>
{% for test in results.keys()|sort if '_' not in test %}
{%   set t_data = results[test] %}
{%   if '_path' in t_data %}
  <tr>
    <td><a href="{{ t_data._path.replace('/','-') }}.html">{{ test.replace('#','.') }}</a></td>
    {{ suite_result(t_data,'unsupported','not supported') }}
    {{ suite_result(t_data,'up','crashed') }}
    {{ suite_result(t_data,'config','configuration failed') }}
    {{ suite_result(t_data,'validate','validation failed',True) }}
  </tr>
{%   else %}
{%     set testurl = github_url + data_path[2] + "/" + test + ".yml" %}
{%     set tname = coverage.get(data_path[-1],{}).get('tests',{}).get(test,'').replace('<br>',' ') %}
  <tr>
    <td><a title="{{ tname }}" href="{{ testurl }}">{{ test }}</a></td>
    {{ test_result(test,t_data,'supported','create') }}
    {{ test_result(test,t_data,'up','up') }}
    {{ test_result(test,t_data,'config','initial') }}
    {{ test_result(test,t_data,'validate','validate') }}
  </tr>
{%     if 'caveat' in t_data or t_data.validate == 'warning' %}
  <tr>
    <td colspan='5' class='caveat'>{{ t_data.caveat or 'No caveat information, inspect the validation results' }}</td>
  </tr>
{%     endif %}
{%   endif %}
{% endfor %}
</table>
<p><b>Notes:</b></p>
<ul>
  <li>Not supported: <em>netlab</em> does not support the function on
      the device (or the device cannot implement it)</li>
{% if results._children|default(False) %}
  <li>Crashed: <b>netlab up</b> crashed, usually due to VM initialization failure
      or timeout</li>
  <li>Config failed: <b>netlab initial</b> failed, usually due to configuration templates
      producing commands that the device refuses to accept</li>
  <li>Validation failed: <b>netlab validate</b> reported an error.</li>
  <li>Caveat: we know why validation failed. The detailed test report describes the caveat</li>
{% else %}
  <li>Lab not started: usually a VM initialization failure or a VM boot timeout</li>
  <li>Devices not configured: <b>netlab initial</b> failed, usually due to configuration templates Jinja2 errors
      or commands that the device refuses to accept</li>
  <li>Not validated: <b>netlab validate</b> reported an error.</li>
  <li>Click on the ✅ or ❌ marks to see log files or error reports</li>
  <li>Hover over the test name to see a short description</li>
  <li>Click on the <b>Test Suite</b> link to view a feature-specific overview of test results for all tested devices</li>
{% endif %}
</ul>
