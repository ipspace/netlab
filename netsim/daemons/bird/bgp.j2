{% if 'router_id' in bgp %}
router id {{ bgp.router_id }};
{% endif %}

{% for pfx in bgp.originate|default([]) %}
{%   if loop.first %}
protocol static bgp_ipv4 {
  ipv4;
{%   endif %}
  route {{ pfx }} unreachable;
{%   if loop.last %}
}
{%   endif %}
{% endfor %}

filter bgp_prefixes {
  if source ~ [ RTS_STATIC, RTS_BGP ]
    then accept "Static or BGP route:", net;

{% if bgp.advertise_loopback|default(False) %}
  if source ~ [ RTS_DEVICE ] && ifname = "lo"
    then accept "advertise loopback:", net;
{% endif %}
{% for intf in interfaces if 'bgp' in intf and intf.bgp.advertise|default(False) %}
  if source ~ [ RTS_DEVICE ] && ifname = "{{ intf.ifname }}"
    then accept "bgp.advertise:", net;
{% endfor %}
  reject "not accepted:", net, " source=", source, " preference=", preference;
}

{% for n in bgp.neighbors %}
{%   for af in [ 'ipv4','ipv6' ] if af in n %}
protocol bgp bgp_{{ n.name }}_{{ af }} {
{%     set loopback = loopback|default({}) %}
{%     set local_ip = loopback[af]|default('') %}
  local {{ local_ip.split('/')[0] if n.type == 'ibgp' else '' }} as {{ n.local_as|default(bgp.as) }};
  neighbor {{ n[af] }} as {{ n['as'] }};
{%     if n.password is defined %}
  password "{{ n.password }}";
{%     endif %}
{%     if n.rs|default(False) %}
  rs client;
{%     endif %}
{%     if n.rs_client|default(False) %}
  enforce first as off;
{%     endif %}
{%     if bgp.rr|default('') and ((not n.rr|default('') and n.type == 'ibgp') or n.type == 'localas_ibgp') %}
  rr client;
{%       if bgp.rr|default(False) and bgp.rr_cluster_id|default(False) %}
  rr cluster id {{ bgp.rr_cluster_id }};
{%       endif %}
{%     endif %}
{%     if af in n.activate and n.activate[af] %}
  {{ af }} {
    import all;
    export filter bgp_prefixes;
    preference 160; # Higher than OSPF 150, default is 100
{%       if 'next_hop_self' in bgp and bgp.next_hop_self and 'ibgp' in n.type %}
    next hop self {{ 'on' if n.type == 'localas_ibgp' else 'ebgp' }};
{%       endif %}
  };
{%     endif %}
}
{%   endfor %}
{% endfor %}
