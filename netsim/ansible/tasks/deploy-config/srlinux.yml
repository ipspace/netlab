---
- local_action:
    module: tempfile
    state: file
    suffix: temp
    prefix: ansible.srl.{{ inventory_hostname }}.
  register: tempfile_1

- local_action:
    module: template
    src: "{{ config_template }}"
    dest: "{{ tempfile_1.path }}"

- block:
  - name: Copy CLI configuration to SRL node {{ ansible_host }} using SCP
    local_action:
      module: command
      cmd: "scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ tempfile_1.path }} linuxadmin@{{ ansible_host }}:{{ cfg_file }}"

  # Uses 'docker' connection plugin to insert CLI config
  - name: Apply CLI configuration
    shell: "sr_cli -ed --post 'commit save' < {{ cfg_file }}"

  vars:
    cfg_file: "/home/linuxadmin/{{ config_template|regex_replace('[\\./]','_') }}.cli"

- local_action:
    module: file
    path: "{{ tempfile_1.path }}"
    state: absent
  when: tempfile_1.path is defined
