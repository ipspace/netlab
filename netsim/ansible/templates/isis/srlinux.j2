updates:
- path: network-instance[name=default]/protocols/isis
  val:
   instance:
   - name: Gandalf
     admin-state: enable
     net: [ "{{ isis.net | default( "%s.0000.0000.%04d.00" % (isis.area,id) ) }}" ]
     level-capability: "{{ 'L2' if isis.type=='level-2' else 'L1' if isis.type=='level-1' else 'L1L2' }}"
     ipv4-unicast:
      admin-state: {{ 'enable' if isis.af.ipv4|default(False) else 'disable' }}
     ipv6-unicast:
      admin-state: {{ 'enable' if isis.af.ipv6|default(False) else 'disable' }}
{% if ldp is defined and ldp.igp_sync|default(True) %}
     ldp-synchronization: { }
{% endif %}
     interface:
     - interface-name: system0.0
       passive: True
       ipv4-unicast:
        admin-state: {{ 'enable' if 'ipv4' in loopback and isis.af.ipv4|default(False) else 'disable' }}
       ipv6-unicast:
        admin-state: {{ 'enable' if 'ipv6' in loopback and isis.af.ipv6|default(False) else 'disable' }}

{%   for l in interfaces if (l.vlan is not defined or l.vlan.mode|default('irb')!='bridge') and l.subif_index is not defined %}
{%    set ifname = l.ifname if '.' in l.ifname else l.ifname|replace('vlan','irb0.') if l.type=='svi' else (l.ifname+'.0') %}
{%    if "isis" not in l %}
     # IS-IS not configured on external interface {{ ifname }}
{%    else %}
     - interface-name: {{ ifname }}
       circuit-type: {{ l.isis.network_type|default("broadcast") }}
       passive: {{ l.isis.passive }}
       ipv4-unicast:
        admin-state: {{ 'enable' if 'ipv4' in l and isis.af.ipv4|default(False) else 'disable' }}
        enable-bfd: {{ l.isis.bfd.ipv4|default(False) }}
       ipv6-unicast:
        admin-state: {{ 'enable' if 'ipv6' in l and isis.af.ipv6|default(False) else 'disable' }}
        enable-bfd: {{ l.isis.bfd.ipv6|default(False) }}
{%     if l.isis.metric is defined or l.isis.cost is defined %}
       level:
       - level-number: 1
         metric-style: wide
         metric: {{ l.isis.metric|default(l.isis.cost) }}
       - level-number: 2
         metric-style: wide
         metric: {{ l.isis.metric|default(l.isis.cost) }}
{%     endif %}
{%    endif %}
{%   endfor %}
