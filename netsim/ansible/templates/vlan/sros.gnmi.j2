{% from "templates/initial/sros.gnmi.j2" import port,interface with context %}

updates:
{% for l in interfaces|default([]) if l.vlan is defined or l.subif_index is defined %}
{% set vlan = 0 if l.vlan.native is defined else l.vlan.access_id|default(True) %}
{% set tagged = l.type=='vlan_member' or l.vlan.trunk_id is defined or l.subif_index is defined %}
{% set native = l.vlan.native is defined %}
{{ port(l,vlan=vlan,tagged=tagged,native=native) }}

{#- Create a VPLS service for each L2 VLAN -#}
{#- Use only vlan.id in name, such that svi interfaces (irb0.nnnn) can be associated -#}
{% set vlan_mode = l.vlan.mode|default('irb') %}
{% if (l.type in ['vlan_member','lan'] and vlan_mode!='route') %}
- path: configure/service/vpls[service-name=vlan{{ vlan }}]
  val:
   service-id: {{ vlan+10000 }}
   customer: "1"
{% if l.name is defined %}
   description: "{{ l.name | replace('->','~')|regex_replace('[\\[\\]]','') }}"
{% endif %}
   sap:
   - sap-id: {{ l.ifname if ':' in l.ifname else (l.ifname+"/1") }}
   admin-state: enable
{% endif -%}

{#- Add L3 interfaces to VPRN service or Base routing context -#}
{%- if l.ipv4 is defined or l.ipv6 is defined %}
{% set base_path = "router[router-name=Base]" if l.vrf is not defined else "service/vprn[service-name="+l.vrf+"]" %}
- path: configure/{{ base_path }}
  val:
   admin-state: enable
   service-id: {{ vrfs[l.vrf].vrfidx if l.vrf is defined else 1 }}
   customer: "1"
   # interface:
   # - interface-name: {{ l.ifname }}
{% endif %}
{% endfor %} {# for l in interfaces #}
