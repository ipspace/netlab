{% from "templates/initial/sros.gnmi.j2" import port,interface with context %}

updates:
{% for l in interfaces|default([]) if l.vlan is defined %}

{{ port(l,vlan=0 if l.vlan.native is defined else l.vlan.access_id|default(0)) }}

{# Create a VPLS service for each L2 VLAN, add L2 side of IRB interface if any #}
{# Use only vlan.id in name, such that svi interfaces (irb0.nnnn) can be associated #}
{% set vlan_mode = l.vlan.mode|default('irb') %}
{% if (l.type in ['vlan_member','lan'] and vlan_mode!='route') or (l.type=='svi' and vlan_mode=='irb') %}
- path: configure/service/vpls[service-name=vlan{{ if_index }}]
  val:
   service-id: {{ if_index }}
{% if l.name is defined %}
   description: "{{ l.name | replace('->','~')|regex_replace('[\\[\\]]','') }}"
{% endif %}
   # interface:
   # - name: {{ if_name }}.{{ if_index }}
   admin-state: enable
{% endif %}

{# Add L3 interfaces to VPRN service or Base routing context #}
{% if l.ipv4 is defined or l.ipv6 is defined %}
{% set base_path = "router[router-name=Base]" if l.vrf is not defined else "service/vprn[service-name="+l.vrf+"]" %}
- path: configure/{{ base_path }}
  val:
   admin-state: enable
   service-id: {{ vrfs[l.vrf].vrfidx }}
   customer: "1"
   # interface:
   # - name: {{ if_name }}.{{ if_index }}
{% endif %}

{% endfor %} {# for l in interfaces #}
