# Generated by sros.gnmi.j2 template

{% macro export_prefix(p,range) %}
- path: configure/policy-options/prefix-list[name=exports]
  val:
   prefix:
   - ip-prefix: {{ p }}
{%   if range %}
     type: range
     start-length: {{ range[0] }}
     end-length: {{ range[1] }}
{%   else %}
     type: "exact"
{%   endif %}
{%- endmacro %}

updates:
- path: configure/router[router-name=Base]
  val:
   router-id: "{{ bgp.router_id }}"
   autonomous-system: {{ bgp.as }}
   bgp:
    ebgp-default-reject-policy:
     import: False
     export: False
    multipath:
     ibgp: {{ 16 if 'ixr' in clab.type else 64 }}
     ebgp: {{ 16 if 'ixr' in clab.type else 64 }}
    min-route-advertisement: 1 # Be aggressive about sending updates
    connect-retry: 5           # Retry frequently, suitable in DC context
    # family: cannot disable this
    # ipv4: False # Enabled by default, disable globally and set per group

{%  if bgp.rr|default(false) is sameas true %}
    cluster:
      cluster-id: "{{ bgp.router_id }}"
    client-reflect: True # Can disable this per group below
{% endif %}

    group:
{% set ibgp_v4 = ['ibgp-ipv4'] if 'ipv4' in loopback else [] %}
{% set ibgp_v6 = ['ibgp-ipv6'] if 'ipv6' in loopback else [] %}
{%  for c in ['ebgp']+ibgp_v4+ibgp_v6 %}
{%  set bgp_type=c[:4] %}
    - group-name: "{{c}}"
      admin-state: enable
      family:
       ipv4: {{ 'ipv4' in bgp.address_families[bgp_type] }}
       ipv6: {{ 'ipv6' in bgp.address_families[bgp_type] }}
      import:
       policy: ["accept_all"]
      export:
       policy: [ {{ 'export_ebgp' if c=='ebgp' else 'accept_all' }} ]
{%    if bgp.community[ bgp_type ]|default([]) %}
      send-communities:
{%     if not ('standard' in bgp.community[ bgp_type ] or 'both' in bgp.community[ bgp_type ]) %}
       standard: False
{%     endif %}
{%     if not ('extended' in bgp.community[ bgp_type ] or 'both' in bgp.community[ bgp_type ]) %}
       extended: False
{%     endif %}
{%     if not ('large' in bgp.community[ bgp_type ]) %}
       large: False
{%     endif %}
{%    endif %}
{%    if c!='ebgp' %}
      local-address: "{{ loopback[ c[5:] ]|ipaddr('address') }}"
{%    if not (bgp.rr|default(false) is sameas true) and bgp.next_hop_self|default(false) %}
      next-hop-self: True
{%    endif %}
{%    endif %}
{%  endfor %}

{% if bgp.neighbors %}
    neighbor:
{%  for n in bgp.neighbors %}
{%  for af in ['ipv4','ipv6'] if n[af] is defined %}
    - ip-address: "{{ n[af] }}"
      description: "{{ n.name }}"
      peer-as: {{ n.as }}
      group: "{{ 'ebgp' if n.type=='ebgp' else (n.type+'-'+af) }}"
{%    if n.local_as is defined %}
      local-as:
       as-number: {{ n.local_as }}
       prepend-global-as: False # Don't include iBGP AS in path
{%    endif %}
{%    if n.advertise_default_route is defined %}
      send-default:
       {{ af }}: True
{% endif %}

{%  endfor %}
{%  endfor %}
{% endif %}

{# Configure BGP exports per address family #}
{% for af in ['ipv4','ipv6'] if bgp[af] is defined %}
{% if loopback[af] is defined and bgp.advertise_loopback %}
{% if bgp.advertise_loopback=='all' %}
{{ export_prefix(pools.loopback[af],(32,32) if af=='ipv4' else (64,128) ) }}
{% else %}
{{ export_prefix(loopback[af],0) }}
{% endif %}
{% endif %}

{% for l in interfaces|default([]) if l.bgp.advertise|default("") and l[af] is defined %}
{{ export_prefix(l[af],0) }}
{% endfor %}

{% for pfx in bgp.originate|default([]) if af == 'ipv4' %}
{{ export_prefix(pfx,0) }}
{% endfor %}
{% endfor %}

- path: configure/policy-options/policy-statement[name=accept_all]
  val:
   default-action:
    action-type: accept

- path: configure/policy-options/policy-statement[name=export_ebgp]
  val:
   default-action:
    action-type: reject
   entry:
   - entry-id: 10
     from:
      prefix-list: [ "exports" ]
     action:
      action-type: accept
