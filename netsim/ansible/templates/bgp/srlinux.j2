{% macro community(list) -%}
{{ "both" if list|length >= 2 else list[0] }}
{%- endmacro %}
{#
   Global BGP neighbor definition
#}
{% macro neighbor_global(n,ip) %}
  neighbor {{ ip }}
   description {{ n.name }}
   peer-group {{ n.type }}
{% if n.type != 'ibgp' %}
   peer-as {{ n.as }}
{% endif %}
  exit
{%- endmacro %}
{#
   Address family BGP neighbor definition
#}
{% macro neighbor_af(n,ip,local_loopback) %}
{% if n.type == 'ibgp' %}
  neighbor {{ ip }} transport local-address {{ local_loopback }}
{%   if bgp.community.ibgp|default([]) %}
  # neighbor {{ ip }} send-community {{ community(bgp.community.ibgp) }} true
{%   endif %}
{%   if bgp.rr|default('') and not n.rr|default('') %}
  neighbor {{ ip }} route-reflector client true
{%   endif %}
{% else %}{# EBGP IPv4 neighbor #}
{%   if bgp.community.ebgp|default([]) %}
  # neighbor {{ ip }} send-community {{ community(bgp.community.ebgp) }} true
{%   endif %}
{% endif %}
{%- endmacro %}
{#
   BGP network statement
#}
{% macro bgp_network(af,pfx) %}
{%   if af == 'ipv4' %}
  network {{ pfx|ipaddr('network') }} mask {{ pfx|ipaddr('netmask') }}
{%   else %}
  network {{ pfx|ipaddr('0') }}
{%   endif %}
{%- endmacro %}

/network-instance default protocols bgp
autonomous-system {{ bgp.as }}
router-id {{ loopback['ipv4']|ipaddr('address') }}
ipv4-unicast admin-state disable
ebgp-default-policy export-reject-all false
ebgp-default-policy import-reject-all false
{#
    Configure IPv4 and IPv6 BGP neighbors
#}
group ibgp admin-state enable peer-as {{ bgp.as }} next-hop-self {{ bgp.next_hop_self|default(false)|lower }}
group ibgp timers connect-retry 1 minimum-advertisement-interval 1
group ebgp admin-state enable next-hop-self {{ bgp.next_hop_self|default(false)|lower }}
group ebgp timers connect-retry 1 minimum-advertisement-interval 1

{% for n in bgp.neighbors %}
{%   for af in ['ipv4','ipv6'] if n[af] is defined %}
{{     neighbor_global(n,n[af]) }}
{%   endfor %}
{% endfor %}

{# Configure BGP address families #}
{% for af in ['ipv4','ipv6'] if bgp[af] is defined %}
 # address-family {{ af }}
 {{ af }}-unicast admin-state enable multipath max-paths-level-1 64 max-paths-level-2 64

{%   if loopback[af] is defined and bgp.advertise_loopback %}
{# {{     bgp_network(af,loopback[af]) }} #}
{%   endif %}

{%   for l in links|default([]) if l.bgp.advertise|default("") and l[af] is defined %}
{# {{     bgp_network(af,l[af]) }} #}
{%   endfor %}
{%   for pfx in bgp.originate|default([]) if af == 'ipv4' %}
{# {{     bgp_network(af,pfx) }} #}
{%   endfor %}

{%   for n in bgp.neighbors if n[af] is defined %}
{{     neighbor_af(n,n[af],loopback[af]|default('')|ipaddr('address')) }}
{%   endfor %}
{% endfor %}

{#
  Define default import/export policies for eBGP
#}
/routing-policy prefix-set host_ips prefix 0.0.0.0/32 mask-length-range 32..32
/routing-policy policy ebgp_import statement 10 match prefix-set host_ips
/routing-policy policy ebgp_import statement 10 action accept
/routing-policy policy ebgp_import default-action reject
/routing-policy policy ebgp_export statement 10 match prefix-set host_ips
/routing-policy policy ebgp_export statement 10 action accept
/routing-policy policy ebgp_export default-action reject
/network-instance default protocols bgp group ebgp import-policy ebgp_import export-policy ebgp_export

{#
  Define default import/export policies for iBGP
#}
/routing-policy prefix-set external_routes
/routing-policy policy ibgp_export default-action reject
/routing-policy policy ibgp_export statement 10 match prefix-set external_routes
/routing-policy policy ibgp_export statement 10 action accept
/network-instance default protocols bgp group ibgp export-policy ibgp_export

{#
  Add extra IPv4 prefixes using static blackhole routes, add to export
#}
/network-instance default next-hop-groups group blackhole blackhole set generate-icmp true
{% for pfx in bgp.originate|default([]) %}
/network-instance default static-routes route {{ pfx }} next-hop-group blackhole
/routing-policy prefix-set external_routes prefix {{ pfx }} mask-length-range exact
{% endfor %}
