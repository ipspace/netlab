{#
   Global BGP neighbor definition
#}
{% macro neighbor_global(n,af) %}
   - peer-address: {{ n[af] }}
     description: {{ n.name }}
     peer-group: {{ 'ebgp' if n.type=='ebgp' else ('ibgp-'+af) }}
{%   if n.type != 'ibgp' %}
     peer-as: {{ n.as }}
{%   if n.local_as is defined %}
     local-as:
     - as-number: {{ n.local_as }}
       prepend-global-as: False # Don't include iBGP AS in advertisements
     # Note: allow-own-as: 1 does not work to allow peer to send global AS
{%   endif %}
{%   if n.advertise_default_route is defined %}
     send-default-route:
      {{ af }}-unicast: True
{% endif %}
{%   endif %}
{%- endmacro %}

{% macro export_prefix(p,range) %}
- path: routing-policy/prefix-set[name=exports]
  val:
   prefix:
   - ip-prefix: {{ p | ipaddr('subnet') }}
     mask-length-range: "{{ range }}"
{%- endmacro %}

updates:
- path: network-instance[name=default]/protocols/bgp
  val:
   autonomous-system: {{ bgp.as }}
   router-id: {{ bgp.router_id }}
   ipv4-unicast:
    admin-state: disable
   ebgp-default-policy:
    export-reject-all: False
    import-reject-all: False
   route-advertisement:
    rapid-withdrawal: True
{#
    Configure BGP Groups
#}
   group:
{% for g in ['ibgp-ipv4','ibgp-ipv6','ebgp'] %}
{% set bgp_type = g[:4] %}
{% set ip_ver = g[5:] %}
{% set ibgp_rr = (g!='ebgp' and bgp.rr|default(0)) %}
   - group-name: {{g}}
     admin-state: enable
     import-policy: accept_all
     export-policy: {{ 'export_ebgp' if g=='ebgp' and bgp.advertise_loopback else 'accept_all' }}
     peer-as: {{ bgp.as }}
     next-hop-self: {{ bgp.next_hop_self|default(0) and not ibgp_rr }}
     timers:
      connect-retry: 1
      minimum-advertisement-interval: 1

{%   if bgp.community[ bgp_type ]|default([]) %}
{%   set list = bgp.community[ bgp_type ] %}
     send-community:
      standard: {{ 'standard' in list or 'both' in list }}
      large: {{ 'large' in list }}
{%   endif %}

     ipv4-unicast:
      admin-state: {{ 'enable' if 'ipv4' in bgp else 'disable' }}
      # advertise-ipv6-next-hops
     ipv6-unicast:
      admin-state: {{ 'enable' if 'ipv6' in bgp else 'disable' }}

{%   if g!='ebgp' and ip_ver in loopback %}
     transport:
      local-address: {{ loopback[ ip_ver ]|ipaddr('address') }}
{% endif %}

{#
    Configure iBGP Route Reflection
#}
{%   if ibgp_rr %}
     route-reflector:
      cluster-id: {{ bgp.router_id }}
      client: True
{%   endif %}
{% endfor %}

{#
    Configure IPv4 and IPv6 BGP neighbors
#}
{% if bgp.neighbors %}
   neighbor:
{% for n in bgp.neighbors %}
{%  for af in ['ipv4','ipv6'] if n[af] is defined %}
{{ neighbor_global(n,af) }}
{%  endfor %}
{% endfor %}
{% endif %}

{# Configure BGP address families #}
{% for af in ['ipv4','ipv6'] if bgp[af] is defined %}
   {{ af }}-unicast:
    admin-state: enable
    multipath:
     max-paths-level-1: 64
     max-paths-level-2: 64 # indirect nexthops

{% if loopback[af] is defined and bgp.advertise_loopback %}
{% if bgp.advertise_loopback=='all' %}
{% if af=='ipv4' %}
{{ export_prefix(pools.loopback[af],'32..32') }}
{% else %}
{{ export_prefix(pools.loopback[af],'64..128') }} # Including SR OS system0/128
{% endif %}
{% else %}
{{ export_prefix(loopback[af],'exact') }}
{% endif %}
{% endif %}

{% for l in interfaces|default([]) if l.bgp.advertise|default("") is sameas true and l[af] is defined %}
{{ export_prefix(l[af],'exact') }}
{% endfor %}

{% for pfx in bgp.originate|default([]) if af == 'ipv4' %}
{{ export_prefix(pfx,'exact') }}
{% endfor %}

{% endfor %}

{#
  Define default import/export policies for iBGP and eBGP: accept all
#}
- path: routing-policy/policy[name=accept_all]
  val:
   default-action:
    accept: {}

- path: routing-policy/policy[name=export_ebgp]
  val:
   default-action:
    reject: {}
   statement:
   - sequence-id: 10
     match:
      prefix-set: "exports"
     action:
      accept: { }

{#
  Add extra IPv4 prefixes using static blackhole routes, add to export
#}
- path: network-instance[name=default]/next-hop-groups/group[name=blackhole]
  val:
   blackhole:
     generate-icmp: True

{% for pfx in bgp.originate|default([]) %}
- path: network-instance[name=default]/static-routes/route[prefix={{pfx}}]
  val:
   next-hop-group: blackhole
{% endfor %}
