{% import "ios.macro.j2" as bgpcfg %}
{% import "templates/routing/_redistribute.ios.j2" as redistribute with context %}
{% set ospf_pid = ospf.process|default(1) %}
!
ip bgp-community new-format
!
router bgp {{ bgp.as }}
 no bgp default ipv4-unicast
 bgp update-delay 5
 bgp nopeerup-delay cold-boot 1
 bgp nopeerup-delay user-initiated 1
{% if bgp.confederation is defined %}
 bgp confederation identifier {{ bgp.confederation.as }}
 bgp confederation peers {{ bgp.confederation.peers|join(' ') }}
{% endif %}
{% if bgp.router_id|ipv4 %}
 bgp router-id {{ bgp.router_id }}
{% endif %}
{% if bgp.rr|default(False) and bgp.rr_cluster_id|default(False) %}
 bgp cluster-id {{ bgp.rr_cluster_id }}
{% endif %}
{#
    Configure IPv4 and IPv6 BGP neighbors
#}
{% for n in bgp.neighbors %}
{%   for af in ['ipv4','ipv6'] if n[af] is defined %}
{{     bgpcfg.neighbor_global(n,n[af]) }}
{%   endfor %}
{% endfor %}
!
{# Configure BGP address families #}
{% for af in ['ipv4','ipv6'] if bgp[af] is defined %}
 address-family {{ af }}
  bgp scan-time 5
{%   if bgp.import is defined %}
{{     redistribute.config(bgp,af=af,ospf_pid=ospf_pid)|indent(1,first=True) }}
{%   endif %}
!
{%   for l in netlab_interfaces if l.bgp.advertise|default("") and l[af] is defined and not 'vrf' in l %}
{%     if loop.first %}
!
! Originate networks from connected subnets
!
{%     endif %}
{{     bgpcfg.bgp_network(af,l[af]) }}
{%   endfor %}
{%   for pfx in bgp.originate|default([]) if af == 'ipv4' %}
{%     if loop.first %}
!
! Originate networks from static routes
!
{%     endif %}
{{     bgpcfg.bgp_network(af,pfx) }}
{%   endfor %}
!
{%   for n in bgp.neighbors if n.activate[af]|default(false) %}
{{     bgpcfg.neighbor_af(n,n[af],bgp) }}
{%   endfor %}
{% endfor %}
!
{#
  Add extra IPv4 prefixes
#}
{% for pfx in bgp.originate|default([]) %}
ip route {{ pfx|ipaddr('network') }} {{ pfx|ipaddr('netmask') }} null 0
{% endfor %}
