# Generated by evpn sros.j2 template
updates:
- path: configure/router[router-name=Base]
  val:
   bgp:
    group:
{%  for type in evpn.session %}
    - group-name: {{ 'ibgp-ipv4' if type=='ibgp' else 'ebgp' }}
      family:
       evpn: True
{%  if bgp.rr|default(0) %}
      next-hop-unchanged:
       evpn: True
{%  endif %}

    rapid-withdrawal: True
    rapid-update:
     evpn: True

{%  endfor %}

{# Configure EVPN parameters for VLANs, TODO bundles #}
{% if vlans is defined %}
{%   for vname,vdata in vlans.items() if vdata.evpn.evi is defined %}
- path: configure/service/vpls[service-name=vlan{{ vdata.id }}]
  val:
   bgp:
   - bgp-instance: 1
     # route-distinguisher: "{{ vdata.evpn.rd }}" # use auto-rd
     route-target:
      export: "target:{{ vdata.evpn.export[0] }}"
      import: "target:{{ vdata.evpn.import[0] }}"

   bgp-evpn:
    evi: {{ vdata.evpn.evi }}
    # TODO if evpn.transport == 'mpls'
    mpls:
    - bgp-instance: 1
      admin-state: enable
      ecmp: {{ 2 if 'ixr' in clab.type else 32 }}
      # ingress-replication-bum-label: True # TODO, requires reserved label range
      auto-bind-tunnel:
       resolution: any
       ecmp: {{ 2 if 'ixr' in clab.type else 32 }}
{%   endfor %}
{% endif %}
