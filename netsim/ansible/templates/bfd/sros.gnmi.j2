{% macro bfd_params() %}
   admin-state: enable
   receive: {{ bfd.min_rx }}
   transmit-interval: {{ bfd.min_tx }}
   multiplier: {{ bfd.multiplier }} # range 1..20
{% if bfd.min_echo_rx != 0 %}
   echo-receive: {{ bfd.min_echo_rx }}
{% else %}
   # TODO delete this setting, default is 100ms
{% endif %}
{% endmacro %}

{% macro bfd_decl(ifname,l) %}
{% set bfd_v4 = isis.bfd.ipv4 if 'bfd' in isis|default({}) else (ospf.bfd if 'bfd' in ospf|default({}) else False) %}
{% set isis_bfd_v6 = isis.bfd.ipv6 if 'bfd' in isis|default({}) else False %}
{% if l.ipv4|default('')|ipv4 and bfd_v4 %}
- path: configure/router[router-name=Base]/interface[interface-name={{ifname}}]/ipv4/bfd
  val:
{{ bfd_params() }}
{% endif %}
{% if (l.ipv6|default('')|ipv6 or l.unnumbered|default(0)) and isis_bfd_v6 %}
- path: configure/router[router-name=Base]/interface[interface-name={{ifname}}]/ipv6/bfd
  val:
{{ bfd_params() }}
{% endif %}
{% endmacro %}

replace:
{# { bfd_decl('system',loopback) } #}
{% for l in interfaces|default([]) if bfd|default(False) or l.bfd|default(False) %}
{% if l.bfd|default(False) %}
{{ bfd_decl('i'+l.ifname,l) }}
{% endif %}
{% endfor %}
