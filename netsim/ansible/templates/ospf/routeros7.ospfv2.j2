
{% if ospf.router_id|ipv4 %}
/routing/ospf/instance add name=default version=2 router-id={{ ospf.router_id }}
{% endif %}

{#
  Create AREA list. If default area != 0.0.0.0, append to list
#}
{% set area_list = [] %}
{#
  For each link, check defined area.
#}
{% for l in interfaces|default([]) if l.ospf.area is defined %}
{{ area_list.append(l.ospf.area) }}
{% endfor %}

{#
  For each unique area, add to area configuration
#}
{% for a_def in area_list|unique %}
/routing/ospf/area add instance=default name={{ a_def }} area-id={{ a_def }}
{% endfor %}

/routing/ospf/interface-template add area=[/routing ospf area find area-id={{ l.ospf.area|default(area) }} and instance=default] interface=loopback passive

{% for l in interfaces|default([]) if 'ospf' in l and 'ipv4' in l %}
{%   if "external" in l.role|default("") %}
## OSPF not configured on external interface {{ l.ifname }}
{%   else %}

{% set ospf_intf_params=[] %}

{%     if l.ospf.passive|default(False) %}
{{ ospf_intf_params.append('passive') }}
{%     endif %}

{%     if l.ospf.network_type is defined %}
{{ ospf_intf_params.append('type='+KW_NETWORK_TYPE[l.ospf.network_type]) }}
{%     endif %}

{%     if l.ospf.cost is defined %}
{{ ospf_intf_params.append('cost='+l.ospf.cost|string) }}
{%     endif %}

{%     if l.ospf.bfd|default(False) %}
## BFD Currently not supported in ROS7 for OSPF
{%     endif %}

{%     if ospf_intf_params|length > 0 %}

/routing/ospf/interface-template add area=[/routing ospf area find area-id={{ l.ospf.area|default(area) }} and instance=default] interface={{ l.ifname }} {{ ospf_intf_params|join(' ') }}

{%     endif %}

{%   endif %}

{% endfor %}
