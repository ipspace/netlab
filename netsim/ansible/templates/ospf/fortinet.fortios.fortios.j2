{% set vdom_traffic = netlab_vdom if (netlab_vdom is defined and netlab_vdom != vdom) else vdom %}
{% set multi_vdom = True if netlab_vdom is defined and netlab_vdom != vdom else False %}

{% if multi_vdom %}
config vdom
    edit {{ vdom_traffic }}
{% endif %}

config router ospf
    set router-id {{ ospf.router_id }}
{%  if ospf.reference_bandwidth is defined %}
    set auto-cost-ref-bandwidth {{ ospf.reference_bandwidth }}
{%  endif %}
{%  set passive_intfs = netlab_interfaces|selectattr('ospf', 'defined')|selectattr('ospf.passive', 'defined')|selectattr('ospf.passive')|map(attribute='ifname')|list %}
{%  if passive_intfs|length > 0 %}
    set passive-interface {{ passive_intfs|join(' ') }}
{%  endif %}
{%  if netlab_interfaces|selectattr('ospf', 'defined')|list|length > 0 %}

    config ospf-interface
{%  for intf in netlab_interfaces if 'ospf' in intf %}
        edit "{{ intf.ifname }}"
            set interface "{{ intf.ifname }}"
{%          if intf.ospf.network_type|default('') == 'point-to-point' %}
            set network-type point-to-point
{%          endif %}
{%          if intf.ospf.cost is defined %}
            set cost {{ intf.ospf.cost }}
{%          endif %}
            set status enable
        next
{%  endfor %}
    end
{%  endif %}

    config area
{%  for area in netlab_interfaces|map(attribute='ospf.area',default='')|unique if area %}
        edit {{ area }}
        next
{%  endfor %}
    end

    config network
{%  for intf in netlab_interfaces if intf.ospf.area is defined %}
        edit {{ intf.ifindex|default(loop.index) }}
            set prefix {{ intf.ipv4|ipaddr('subnet') }}
            set area {{ intf.ospf.area }}
        next
{%  endfor %}
    end
end
