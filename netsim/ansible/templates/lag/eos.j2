{# Provision mlag peerlink, EOS supports at most 1 peerlink #}
vlan {{ lag.mlag.vlan }}
 name "MLAG-peerlink"
 trunk group m1peer
!
no spanning-tree vlan-id {{ lag.mlag.vlan }}

interface port-channel {{ lag.mlag.ifindex }}
 description MLAG peerlink(s)
 switchport mode trunk
 switchport trunk group m1peer
!

interface vlan {{ lag.mlag.vlan }}
 description MLAG peerlink local-interface
 no autostate
!

mlag
 domain-id mlagDomain
 local-interface vlan {{ lag.mlag.vlan }}
 peer-address {{ lag.mlag.peer }}
 peer-link port-channel {{ lag.mlag.ifindex }}
 no shutdown
!

{% if 'gateway' in module %}
ip virtual-router mac-address mlag-peer
{% endif %}
{% endfor %}

{% for intf in interfaces if intf.type == 'lag' %}
interface {{ intf.ifname }}
{%  if '_mlag' in intf.lag %}
 description {{ intf.name }} (part of mlag {{ intf.lag.ifindex }})
 switchport
 mlag {{ intf.lag.ifindex }}
{% else %}
 description {{ intf.name }}
{%  endif %}
!
{%   for ch in interfaces if ch.lag._parentindex|default(None) == intf.lag.ifindex %}
!
{%     set _lag_mode = 
         'on' if intf.lag.lacp|default('') == 'off' else
         'active' if intf.lag.lacp_mode|default('') == 'active' else 
         'passive' %}
interface {{ ch.ifname }}
 description {{ ch.name }} in channel-group {{ intf.lag.ifindex }}
 channel-group {{ intf.lag.ifindex }} mode {{ _lag_mode }}
{%     if intf.lag.lacp|default('') == 'fast' %}
 lacp timer fast
{%     endif %}
{%   endfor %}
{% endfor %}
