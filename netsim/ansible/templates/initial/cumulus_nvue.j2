{% macro decl_interface(i) %}
      {{ i.ifname }}:
        link:
{%  if i.mtu is defined %}
          mtu: {{ i.mtu }}
{%  endif %}
          state:
            up: {}
{%  if i.name is defined %}
        description: "{{ i.name }}{{ " ["+i.role+"]" if i.role is defined else "" }}"
{%  elif i.type|default("") == "stub" %}
        description: Stub interface
{%  endif %}
{%  if i.ipv4 is defined or i.ipv6 is defined %}
        ip:
          address:
{%    if i.ipv4 is defined %}
{%      if i.ipv4 == True %}
            {{ loopback.ipv4 }}: {}
{%      else %}
            {{ i.ipv4 }}: {}
{%      endif %}
{%    endif %}
{%    if i.vrf is defined %}
          vrf: {{ i.vrf }}
{%    endif %}
{%    if i.ipv6 is defined %}
{%      if i.ipv6 is string %}
            {{ i.ipv6 }}: {}
{%      endif %}
{%    else %}
          ipv6:
            enable: off
{%    endif %}
{%  endif %}
{% endmacro %}

- set:
    system:
      hostname: {{ inventory_hostname }}
    interface:
      eth0:
        ip:
          vrf: mgmt
          address:
            dhcp: {}
        type: eth
      lo:
        ip:
          address:
{% if 'ipv4' in loopback %}
            {{ loopback.ipv4 }}: {}
{% else %}
            127.0.0.1: {}
{% endif %}
{% if 'ipv6' in loopback %}
            {{ loopback.ipv6 }}: {}
{% else %}
          ipv6:
            enable: off
{% endif %}
        type: loopback
{% for l in interfaces|default([]) if l.type in ['lan','p2p','stub','svi'] %}
{{      decl_interface(l) }}
        type: {{ 'svi' if l.type=='svi' else 'swp' }}
{% endfor %}
