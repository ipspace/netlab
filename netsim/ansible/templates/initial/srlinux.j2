#!/bin/bash
#
set -e
#
# Create bash profile script
#
# cat <<SCRIPT >/root/.bash_profile
# #!/bin/bash
# #
# export PS1="\h(bash)#"
# echo "Use vtysh to connect to FRR daemon"
# echo
# SCRIPT
#
# Build hosts file
#
# hostname {{ inventory_hostname }}
# {% if ansible_connection != "docker" %}
# awk '/127.0.1.1/,/^$/' /etc/hosts >/tmp/hosts
# echo "127.0.0.1 {{ inventory_hostname }}" >>/tmp/hosts
# {% for k,v in hostvars.items() if v.loopback.ipv4 is defined and k != inventory_hostname %}
# echo "{{ v.loopback.ipv4|ipaddr('address') }}{%- for l in v.links|default([]) if l.ipv4 is defined %} {{ l.ipv4|ipaddr('address') }}{%- endfor %} {{ k }}" >>/tmp/hosts
# {% endfor %}
# cat /etc/hosts | awk '/localhost/,/^$/' >/tmp/hosts-start
# mv /tmp/hosts-start /etc/hosts
# sort /tmp/hosts|uniq >>/etc/hosts
# {% endif %}
#
# Enable LLDP
#
# cat <<CONFIG >/etc/lldpd.d/system.conf
# configure lldp tx-interval 30
# configure lldp tx-hold 3
# configure system interface pattern *,!eth0,swp*
# CONFIG
# service lldpd restart
#
# Enable FRR modules
#
# {% set modlist = {'bgp':'bgpd','ospf':'ospfd','isis':'isisd'} %}
# {% for m in module|default([]) if modlist[m] is defined %}
# echo "{{ modlist[m] }}=yes" >>/etc/frr/daemons
# {% endfor %}
# systemctl enable frr.service
# systemctl start frr.service
# systemctl reload frr.service
#
# Rest of initial configuration done through VTYSH
#
cat >/tmp/config <<CONFIG
/interface lo0 subinterface 0
{% if 'ipv4' in loopback %}
 ipv4 address {{ loopback.ipv4 }}
 exit
{% endif %}
{% if 'ipv6' in loopback %}
 ipv6 address {{ loopback.ipv6 }}
 exit
{% endif %}

{% for l in links|default([]) %}
/interface {{ l.ifname }} subinterface 0
{% if l.name is defined %}
 description {{ l.name }}{{ " ["+l.role+"]" if l.role is defined else "" }}
{% elif l.type|default("") == "stub" %}
 description Stub interface
{% endif %}
{% if l.ipv4 is defined %}
 ipv4 address {{ l.ipv4 }}
{% endif %}
{% if l.ipv6 is defined %}
 ipv6 address {{ l.ipv6 }}
 # ipv6 nd ra-interval 5
 # no ipv6 nd suppress-ra
{% endif %}
{% if l.bandwidth is defined %}
 # bandwidth {{ l.bandwidth  }}
{% endif %}
{% endfor %}
CONFIG

# vtysh -f /tmp/config
sr_cli -ed --post 'commit save' < /tmp/config
