{% macro ip_addr(v,ip) %}
{% set _ip = ip|ipaddr('address') %}
{% set _pre = ip|ipaddr('prefix') %}
ipv{{v}}:
           addresses:
            address:
            - ip: "{{_ip}}"
              config:
               ip: "{{_ip}}"
               prefix-length: {{ _pre }}
{% endmacro %}

{% macro interface(name,type,desc,ip_v4,ip_v6) -%}
- path: "openconfig-interfaces:interfaces/interface[name={{name}}]"
  val:
    name: "{{name}}"
    config:
      name: "{{name}}"
      enabled: true
      type: "{{type}}"
      description: "{{desc}}"
    subinterfaces:
      subinterface:
      - index: 0
        config:
          index: 0
          enabled: true
{% if ip_v4|ipv4 %}
        {{ ip_addr('4',ip_v4) }}
{% endif %}
{% if ip_v6|ipv6 %}
        {{ ip_addr('6',ip_v6) }}
{% endif %}
{%- endmacro -%}

updates:
{% if 'ipv4' in loopback or 'ipv6' in loopback %}
{{ interface("system","softwareLoopback","loopback interface",
             loopback.ipv4|default(''), loopback.ipv6|default('') ) }}
{% endif %}
{% for l in links|default([]) %}
{% if l.name is defined %}
{% set desc = l.name|replace('->','~') + " (" + l.role|default('') + ")" %}
{% elif l.type|default("") == "stub" %}
{% set desc = "Stub interface" %}
{% endif %}
- path: configure/port[port-id={{l.ifname}}]
  val: { connector: { "breakout": "c1-100g" } }
{{ interface(l.ifname+"/1","ethernetCsmacd",desc,
             l.ipv4|default(''), l.ipv6|default('') ) }}
{% endfor %}
