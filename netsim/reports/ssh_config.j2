{% set ssh_defaults = defaults.ssh|default({}) %}
{% set hostname = ssh_defaults.hostname|default('netlab') %}
{% set public_ip = ssh_defaults.publicip|default('127.0.0.1') %}
{% set netlab_path = ssh_defaults.netlabpath|default('netlab') %}
#
# This SSH configuration file allows you to connect to netlab devices running
# on a remote server  straight from your workstation
#
# Save it into the ~/.ssh directory (or similar) and include it in your ~/.ssh/config
# file with the "Include" directive (which has to be before the first Host directive)
#
# You can change the SSH parameters with these environment variables
#
# NETLAB_SSH_HOSTNAME         The hostname used for port forwarding (not implemented yet)
# NETLAB_SSH_PUBLICIP         The IP address or hostname of the netlab server
# NETLAB_SSH_NETLABPATH       The path to 'netlab' command (if it's not in PATH)
#
Host {{ hostname }}
  HostName {{ public_ip }}
{# for host in groups['fortios'] %}
{%   set hv = hostvars[host] %}
{%   if hv.get('provider') != 'clab' %}
  LocalForward {{ 8000 + hv.id }} {{ hv.ansible_host }}:443
{%   endif %}
{% endfor #}

{% for n_name,n_data in nodes.items() %}
Host {{ n_name }}
  HostName {{ public_ip }}
  RequestTTY yes
  RemoteCommand {{ netlab_path }} connect -i {{ defaults.multilab.id|default('default') }} {{ n_name }}
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  LogLevel QUIET

{% endfor %}
