{% set modules = nodes.values() | sum(attribute='module', start=[]) | unique %}
{% set neighbors_by_host = {} %}
{% if 'ospf' in modules %}
- test_class: TestNetmikoOspfNeighbors
  test_data:
{% for nn,nd in nodes.items()
     if nd.ospf %}
{%    for interface in nd.interfaces if interface.ospf %}
{%      for neighbor in interface.neighbors %}
{#        Can not use "nodes[neighbor.node] | community.general.json_query('interfaces[?ifname==`' ~ neighbor.ifname ~ '`] | [0]')" #}
{%        for remote_interface in nodes[neighbor.node].interfaces if remote_interface.ifname == neighbor.ifname %}
{%          if remote_interface.ospf %}
{%            set _ = neighbors_by_host.update({nn: neighbors_by_host.get(nn, []) + [neighbor]}) %}
    - host: {{ nn }}
      local_port: {{ interface.ifname }}
      neighbor_id: {{ nodes[neighbor.node].ospf.router_id }}
      # state: FULL/BDR
      neighbor_address: {{ neighbor.ipv4.split('/')[0] }}
{%          endif %}
{%        endfor %}
{%      endfor %}
{%    endfor %}
{% endfor %}

- test_class: TestNetmikoOspfNeighborsCount
  test_data:
{% for nn,nd in neighbors_by_host.items() %}
    - host: {{ nn }}
      neighbor_count: {{ nd | length }}
{% endfor %}
{% else %}
# No tests
{% endif %}
