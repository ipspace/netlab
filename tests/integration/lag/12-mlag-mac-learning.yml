message: |
  Based on https://blog.ipspace.net/2022/06/mlag-deep-dive-mac-learning/

  The devices under test are an MLAG pair connected to 5 Linux hosts.
  The attached hosts should be able to ping each other.

groups:
  _auto_create: true
  switches:
    members: [ s1, s2 ]
    module: [ lag, vlan ]
  lag-hosts:
    members: [ a, b, c ]
    device: linux
    module: [ lag ]
    # provider: clab # Need to use the same provider for LACP to work
  single-hosts:
    members: [ x, y ]
    device: linux
    provider: clab

vlans:
  red:
    mode: bridge
    links: [ x-s1, y-s2 ]

links:
- lag:
    members: [s1-s2]
    mlag.peergroup: true
- lag.members: [ a-s1, a-s2 ]
  vlan.access: red
- lag.members: [ b-s1, b-s2 ]
  vlan.access: red
- lag.members: [ c-s1, c-s2 ]  # c-s1 is set "down"
  vlan.access: red

validate:
  c_eth1_down:
    description: Shut down the link c-s1
    nodes: [ c ]
    devices: [ linux ]
    exec: ip link set {{ interfaces[0].ifname }} down
  ping:
    description: End-to-end connectivity test
    nodes: [ a, b, c, x ]
    wait_msg: Waiting for STP to enable the ports
    wait: 45
    plugin: ping('y')
