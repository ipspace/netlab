---
message: |
  The devices under test are 2 mlag pairs of VLAN-to-VXLAN bridges between two access VLANs
  and two VXLAN VNIs. Both VLANs are using the same IP prefix to identify
  potential inter-VLAN leaking.

  The first pair uses the mlag.vtep plugin to provision an anycast MLAG VTEP across both.

  * h1,h2 and h3,h4 should be able to ping each other
  * h1 should not be able to reach h3 or h4

  Please note it might take a while for the lab to work due to
  STP learning phase

defaults.devices.dellos10:
  warnings.svi_ospf: False
  features.vlan.svi_interface_name: vlan{vlan}

plugin: [ mlag.vtep ]

stp.protocol: pvrst

groups:
  _auto_create: True
  hosts:
    members: [ h1, h2, h3, h4 ]
    device: linux
    provider: clab
  switches:
    members: [ s1, s2, s3, s4 ]
    module: [ vlan, vxlan, ospf, lag, stp ] # Requires STP to block massive loop
    mtu: 1600

nodes:
  s1:
    device: cumulus_nvue
    #lag.mlag.vtep: False
  s2:
    device: cumulus_nvue
    #lag.mlag.vtep: False

vlans:
  ospf_vxlan:
    mode: irb  # 'route' would be better, but Dell OS10 templates don't support it yet
  red:
    mode: bridge
    prefix:
      ipv4: 172.31.1.0/24
    links: [ s1-h1, s4-h2 ]
  blue:
    mode: bridge
    prefix:
      ipv4: 172.31.1.0/24
    links: [ s2-h3, s3-h4 ]

vxlan.vlans: [ red, blue ]

links:
- lag:
    members: [ s1-s2 ]
    mlag.peergroup: True
- lag:
    members: [ s3-s4 ]
    mlag.peergroup: True
- lag:
    members:
    - s1-s3
    - s1-s4
    - s2-s3
    - s2-s4
  vlan.trunk: [ ospf_vxlan ] # 'red' and 'blue' are passed as VXLAN (vlan.access doesn't work)

validate:
  ping_red:
    description: Ping-based reachability test in VLAN red
    wait_msg: Waiting for OSFP and STP to wake up
    wait: 50
    nodes: [ h1 ]
    plugin: ping('h2')
  ping_blue:
    description: Ping-based reachability test in VLAN blue
    wait_msg: We might have to wait a bit longer
    wait: 10
    nodes: [ h3 ]
    plugin: ping('h4')
  inter_vlan:
    description: Ping-based reachability test between blue and red VLANs
    nodes: [ h1 ]
    devices: [ linux ]
    plugin: ping('h4',expect='fail')
